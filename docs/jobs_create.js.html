<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>jobs/create.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="jobs.html">jobs</a><ul class='methods'><li data-type='method'><a href="jobs.html#.artifactsDestroy">artifactsDestroy</a></li><li data-type='method'><a href="jobs.html#.artifactsGet">artifactsGet</a></li><li data-type='method'><a href="jobs.html#.artifactsList">artifactsList</a></li><li data-type='method'><a href="jobs.html#.clone">clone</a></li><li data-type='method'><a href="jobs.html#.create">create</a></li><li data-type='method'><a href="jobs.html#.destroy">destroy</a></li><li data-type='method'><a href="jobs.html#.list">list</a></li><li data-type='method'><a href="jobs.html#.logs">logs</a></li><li data-type='method'><a href="jobs.html#.show">show</a></li><li data-type='method'><a href="jobs.html#.stop">stop</a></li><li data-type='method'><a href="jobs.html#.waitfor">waitfor</a></li></ul></li><li><a href="machines.html">machines</a><ul class='methods'><li data-type='method'><a href="machines.html#.availability">availability</a></li><li data-type='method'><a href="machines.html#.create">create</a></li><li data-type='method'><a href="machines.html#.destroy">destroy</a></li><li data-type='method'><a href="machines.html#.list">list</a></li><li data-type='method'><a href="machines.html#.restart">restart</a></li><li data-type='method'><a href="machines.html#.show">show</a></li><li data-type='method'><a href="machines.html#.start">start</a></li><li data-type='method'><a href="machines.html#.stop">stop</a></li><li data-type='method'><a href="machines.html#.update">update</a></li><li data-type='method'><a href="machines.html#.utilization">utilization</a></li><li data-type='method'><a href="machines.html#.waitfor">waitfor</a></li></ul></li><li><a href="networks.html">networks</a><ul class='methods'><li data-type='method'><a href="networks.html#.list">list</a></li></ul></li><li><a href="project.html">project</a><ul class='methods'><li data-type='method'><a href="project.html#.init">init</a></li><li data-type='method'><a href="project.html#.show">show</a></li></ul></li><li><a href="scripts.html">scripts</a><ul class='methods'><li data-type='method'><a href="scripts.html#.create">create</a></li><li data-type='method'><a href="scripts.html#.destroy">destroy</a></li><li data-type='method'><a href="scripts.html#.list">list</a></li><li data-type='method'><a href="scripts.html#.show">show</a></li><li data-type='method'><a href="scripts.html#.text">text</a></li></ul></li><li><a href="templates.html">templates</a><ul class='methods'><li data-type='method'><a href="templates.html#.list">list</a></li></ul></li><li><a href="users.html">users</a><ul class='methods'><li data-type='method'><a href="users.html#.list">list</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">jobs/create.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

var method = require('./../method');
var assign = require('lodash.assign');
var path = require('path');
var async = require('async');
var os = require('os');
var fs = require('fs');
var archiver = require('archiver');
var ProgressBar = require('progress');
var projectConfig = require('./../projectConfig');

/**
 * @memberof jobs
 * @method create
 * @description Create a new Paperspace job.
 * @param {object} params - Job creation parameters
 * @param {string} params.container - A required reference to a container name or container link to be used for the job.
 * @param {string} [params.machineType] - An optional machine type to run the job on: either 'GPU+', 'P4000', 'P5000', 'P6000', 'V100', 'C1', 'C2', 'C3', 'C4', 'C5', 'C6', 'C7', 'C8', 'C9', or 'C10'.&lt;p>Defaults to 'GPU+'.
 * @param {string} [params.name] - An optional name or description for this job.  If ommitted, the job name defaults to 'job for project [projectname]'.
 * @param {string} [params.project] - The name of the project for this job.  If not provided, this is taken from the .ps_project/config.json file, or the current directory name.
 * @param {string} [params.projectId] - The poject id of an existing project for this job.  Note: if projectId is specified, the project parameter cannot be specified.
 * @param {string} [params.command] - An optional command to run within the workspace or container.
 * @param {string} [params.workspace] - An optional path to a workspace, or link to a git repository to upload and merge with the container.  If a zip file name is provided it is uploaded instead.  If no workspace is provided the current directory is zipped up and transferred.  If the workspace is 'none', no workspace is merged and the container is run as-is.
 * @param {string} [params.dataset] - An optional reference to a dataset to be merged with the container.
 * @param {boolean} [params.json] - Optional; if true, do not write progress to standard out.  '--json' with no value is equivalent to true.
 * @param {function} cb - Node-style error-first callback function
 * @returns {object} job - The created job JSON object
 * @example
 * paperspace.jobs.create({
 *   container: 'http://dockerhub.com/mycontainer',
 *   machineType: 'P6000',
 * }, function(err, resp) {
 *   // handle error or http response
 * });
 * @example
 * $ paperspace jobs create \
 *     --container "http://dockerhub.com/mycontainer" \
 *     --machineType "P6000"
 * @example
 * # HTTP request:
 * https://api.paperspace.io
 * POST /jobs/createJob { "container": "http://dockerhub.com/mycontainer", "machineType": "P6000" }
 * x-api-key: 1ba4f98e7c0...
 * # Returns 201 on success
 * @example
 * // Example return value:
 * {
 *   "id": "j123abc",
 *   "name": "job for project myproject",
 *   "state": "Pending",
 *   "workspaceUrl": "myproject.zip",
 *   "workingDirectory": "/paperspace",
 *   "artifactsDirectory": "/artifacts",
 *   "entrypoint": "echo Hello Paperspace",
 *   "projectId": "pr456def",
 *   "project": "myproject",
 *   "container": "http://dockerhub.com/mycontainer",
 *   "machineType": "P6000",
 *   "cluster": "Jobs",
 *   "usageRate": "P6000 hourly",
 *   "startedByUserId": "u789ghi",
 *   "parentJobId": null,
 *   "jobError": null,
 *   "dtCreated": "2017-11-30T18:46:10.394Z",
 *   "dtModified": "2017-11-30T18:46:10.394Z",
 *   "dtProvisioningStarted": null,
 *   "dtProvisioningFinished": null,
 *   "dtStarted": null,
 *   "dtFinished": null,
 *   "dtTeardownStarted": null,
 *   "dtTeardownFinished": null,
 *   "dtDeleted": null,
 *   "exitCode": null
 * }
 */

function expandHomeDir(pathIn) {
	var homedir = process.env[(process.platform == 'win32') ? 'USERPROFILE' : 'HOME'];
	if (!pathIn) return pathIn;
	if (pathIn == '~') return homedir;
	if (pathIn.slice(0, 2) !== '~/') return pathIn;
	return path.join(homedir, pathIn.slice(2));
}

function directorySize(path, cb, size) {
  if (size === undefined) {
    size = 0;
  }

  fs.stat(path, function(err, stat) {
    if (err) {
      cb(err);
      return;
    }

    size += stat.size;

    if (!stat.isDirectory()) {
      cb(null, size);
      return;
    }

    fs.readdir(path, function(err, paths) {
      if (err) {
        cb(err);
        return;
      }

      async.map(paths.map(function(p) { return path + '/' + p; }), directorySize, function(err, sizes) {
        size += sizes.reduce(function(a, b) { return a + b; }, 0);
        cb(err, size);
      });
    });
  });
}

var MAX_UPLOAD_SIZE = 104857600; // 100MB

function create(params, cb) {
	var cwd = process.cwd();
	if (!params.project &amp;&amp; !params.projectId) {
		// default to name of project in .ps_project/config.json or name of current directory
		params.project = projectConfig.getProject();
		if (!params.project) {
			params.project = path.basename(cwd);
			if (params.project === '/') {
				return ifCliPrintErrorOnly(new Error('Error: cannot create project from root dir. Please create a project dir and run from there.'));
			}
		}
	}
	var json = false;
	if (params.json) {
		json = true;
		// Note: we don't delete params.json because lib/request.js needs to examine it to determine if upload progress should be displayed
	}

  // XXX TODO trim leading/trailing spaces from input paths
	// XXX TODO whitelist git services
	// XXX TODO convert to gzip
	// XXX TODO stream compress

	if (!params.workspace) params.workspace = cwd;

	function ifCliPrintErrorOnly(err) {
		if (global.paperspace_cli &amp;&amp; !json) {
			console.log(err.message);
			return cb();
		}
		return cb(err);
	}

	// don't allow zipping of the root directory
	if (params.workspace === '/') {
		return ifCliPrintErrorOnly(new Error('Error: cannot zip workspace from root directory.'));
	}

	if (params.workspace !== 'none' &amp;&amp; !params.workspace.startsWith('https://') &amp;&amp; !params.workspace.startsWith('git+https://')) {
		params.workspace = expandHomeDir(params.workspace);
		if (!fs.existsSync(params.workspace)) {
			return ifCliPrintErrorOnly(new Error('Error: cannot find workspace file or directory.'));
		}
		var stat = fs.statSync(params.workspace);
		if (!stat.isDirectory() &amp;&amp; !stat.isFile()) {
			return ifCliPrintErrorOnly(new Error('Error: workspace is not a file or directory.'));
		}

		// zip the workspace file if it is not already a zip file
		if (!params.workspace.endsWith('.zip') &amp;&amp; !params.workspace.endsWith('.gz')) {

			// construct zip file name in tmpdir
			var zip_file = path.resolve(os.tmpdir(), path.basename(params.workspace) + '.zip');

			// delete prior zip file if it exists
			if (fs.existsSync(zip_file)) {
				fs.unlinkSync(zip_file);
			}

			function zipFunc(err, totalSize) { // eslint-disable-line no-inner-declarations
				var output = fs.createWriteStream(zip_file);
				var archive = archiver('zip', {
					zlib: { level: 9 } // Sets the compression level.
				});

				// listen for all archive data to be written
				// 'close' event is fired only when a file descriptor is involved
				output.on('close', function() {
					// check it does not exceed the current limit for upload using loopback storage component with s3
					if (getFilesizeInBytes(zip_file) > MAX_UPLOAD_SIZE) {
						var err = new Error('Error: zipped workspace ' + zip_file + ' cannot exceed ' + MAX_UPLOAD_SIZE + ' bytes.');
						return ifCliPrintErrorOnly(err);
					}

					// save name of the workspace file for superagent to attach it
					params.workspace = zip_file;

					// save workspace file name as a extra parameter since we are not using multer to parse the files on the server
					params.workspaceFileName = path.basename(params.workspace);
					return method(create, params, function _methodCb(err, resp) {
						if (err) return cb(err);
						if (resp.body) projectConfig.setLastJobId(resp.body.project, resp.body.id);
						return cb(err, resp);
					});
				});

				archive.on('error', function(err) {
					console.error('Error while zipping: ', err);
				});

				var bar;
				var prev_zipped = 0;

				if (stat.isDirectory() &amp;&amp; global.paperspace_cli &amp;&amp; !json) {
					archive.on('progress', function(progress) {
						if (!bar) {
							bar = new ProgressBar('Zipping directory ' + path.basename(params.workspace) + ' [:bar] :rate/bps :percent :etas', {
								complete: '=',
								incomplete: ' ',
								width: 40,
								total: totalSize,
							});
						}
						var chunkSize = progress.fs.processedBytes - prev_zipped;
						prev_zipped = progress.fs.processedBytes;
						bar.tick(chunkSize);
					});
				}

				// good practice to catch warnings (ie stat failures and other non-blocking errors)
				archive.on('warning', function(err) {
					if (err.code === 'ENOENT') {
						// log warning
						console.error(err.code);
					} else {
						// throw error
						throw err;
					}
				});

				archive.pipe(output);
				if (stat.isDirectory()) {
					archive.directory(params.workspace, false);
				}
				else {
					var basename = path.basename(params.workspace);
					archive.file(params.workspace, { name: basename } );
				}
				archive.finalize();
			}

			if (stat.isDirectory()) {
				directorySize(params.workspace, zipFunc);
			} else {
				if (global.paperspace_cli &amp;&amp; !json) {
					console.log('Zipping file ' + path.basename(params.workspace));
				}
				zipFunc(null, getFilesizeInBytes(params.workspace));
			}
		} else {
			// workspace is a zip or gzip file

			// check it does not exceed the current limit for upload using loopback storage component with s3
			if (getFilesizeInBytes(params.workspace) > MAX_UPLOAD_SIZE) {
				var err = new Error('Error: zipped workspace ' + params.workspace + ' cannot exceed ' + MAX_UPLOAD_SIZE + ' bytes.');
				return ifCliPrintErrorOnly(err);
			}

			// save workspace file name as a extra parameter since we are not using multer to parse the files on the server
			params.workspaceFileName = path.basename(params.workspace);
			return method(create, params, function _methodCb(err, resp) {
				if (err) return cb(err);
				if (resp.body) projectConfig.setLastJobId(resp.body.project, resp.body.id);
				return cb(err, resp);
			});
		}
	} else {
		// workspace is either a link or 'none'

		// if link pass in workspaceFileName param for jobs service to download it when running the job
		if (params.workspace.startsWith('https://') || params.workspace.startsWith('git+https://')) params.workspaceFileName = params.workspace;

		// don't try to upload it; we normally attempt to upload anything in the workspace param specified in assign() below
		delete params.workspace;
		return method(create, params, function _methodCb(err, resp) {
			if (err) return cb(err);
			if (resp.body) projectConfig.setLastJobId(resp.body.project, resp.body.id);
			return cb(err, resp);
		});
	}
}

function getFilesizeInBytes(filename) {
  var stats = fs.statSync(filename);
  var fileSizeInBytes = stats['size'];
  return fileSizeInBytes;
}

assign(create, {
	auth: true,
	group: 'jobs',
	name: 'create',
	method: 'post',
	route: '/jobs/createJob',
	requires: {
		container: 'string',
	},
	file: 'workspace',
	returns: {},
});

module.exports = create;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Dec 12 2017 22:38:33 GMT-0500 (EST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
